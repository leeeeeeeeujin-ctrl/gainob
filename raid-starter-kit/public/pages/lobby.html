<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ë¡œë¹„ - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css"/>
  <link rel="manifest" href="/manifest.webmanifest"/>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h1 style="margin:0;font-size:24px;">ğŸ° Raid Lobby</h1>
        </div>
        <div class="row">
          <input id="myName" class="input" style="max-width:200px" placeholder="í”Œë ˆì´ì–´ ì´ë¦„"/>
          <a href="character.html" class="btn">ìºë¦­í„° ìƒì„±</a>
          <a href="roster.html" class="btn">ë¡œìŠ¤í„°</a>
          <a href="prompt.html" class="btn">í”„ë¡¬í”„íŠ¸</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns:1fr 400px;">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h3>ë°© ëª©ë¡</h3>
        <button id="mk" class="btn primary">ë°© ë§Œë“¤ê¸°</button>
      </div>
      <div id="rooms" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-top:16px;"></div>
    </section>

    <aside class="card">
      <h3>ë¡œë¹„ ì±„íŒ…</h3>
      <div id="log" style="height:300px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px;background:#fafafa;margin-bottom:8px;"></div>
      <div class="row">
        <input id="txt" class="input grow" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
        <button id="send" class="btn primary">ì „ì†¡</button>
      </div>
    </aside>
  </div>

<script type="module">
  import { Store } from '../core/store.js';
  import { API } from '../core/api.js';
  import { WS } from '../core/ws.js';

    const roomsBox = document.getElementById('rooms');
    const nameInput = document.getElementById('myName');
    const log = document.getElementById('log');
    const txt = document.getElementById('txt');

    nameInput.value = Store.state.name || '';
    nameInput.addEventListener('change', () => { Store.setName(nameInput.value.trim() || 'Player'); });

    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function pushChat(name, text){ const div=document.createElement('div'); div.style.marginBottom='4px'; div.innerHTML=`<b>${escapeHtml(name)}:</b> ${escapeHtml(text)}`; log.appendChild(div); log.scrollTop = log.scrollHeight; }

    async function loadRooms(){
      try{
        const active = localStorage.getItem('RSK_ACTIVE_ROOM');
        const clientId = Store.state.clientId;
        const { rooms } = await API.listRooms();

        roomsBox.innerHTML = (rooms||[]).map(room=>{
          const isActive = active && room.id === active;
          const locked = !!active && !isActive;
          const actionHtml = isActive
            ? `<a class="btn" href="room.html?room=${encodeURIComponent(room.id)}">ì°¸ì—¬ì¤‘ Â· ì¬ì…ì¥</a>`
            : (locked ? `<button class="btn" disabled title="ë‹¤ë¥¸ ë°©ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤">ì°¸ê°€í•˜ê¸°</button>` : `<a class="btn primary" href="room.html?room=${encodeURIComponent(room.id)}">ì°¸ê°€í•˜ê¸°</a>`);
          return `<div class="card"><h4>${escapeHtml(room.title)}</h4><div class="meta">${room.players}/${room.max}ëª… Â· ${room.boss ? 'ë³´ìŠ¤ ìˆìŒ' : 'ë³´ìŠ¤ ì—†ìŒ'} Â· ${escapeHtml(room.status||'')}</div><div class="row" style="margin-top:8px;">${actionHtml}</div></div>`;
        }).join('') || '<div class="meta">ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';

        const mk = document.getElementById('mk');
        if (mk) { if (active){ mk.disabled = true; mk.title = 'ë‹¤ë¥¸ ë°©ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤'; } else { mk.disabled = false; mk.removeAttribute('title'); } }
      }catch(e){ console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e); roomsBox.innerHTML = '<div class="meta">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>'; }
    }

    // ë°© ë§Œë“¤ê¸°
    document.getElementById('mk').addEventListener('click', ()=>{
      if (document.getElementById('roomModal')) return;
      const modal = document.createElement('div');
      modal.id = 'roomModal';
      modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;z-index:1000;background:rgba(0,0,0,0.3);';
      modal.innerHTML = `
        <div style="background:#fff;padding:32px;border-radius:12px;min-width:320px;box-shadow:0 4px 24px #0002;">
          <h3 style="margin-top:0">ë°© ì„¤ì •</h3>
          <div style="margin-bottom:12px"><label>ë°© ì´ë¦„<br><input id="roomTitle" class="input" style="width:100%" value="ìƒˆ ë°©"></label></div>
          <div style="margin-bottom:12px"><label>ì„¤ëª…<br><input id="roomDesc" class="input" style="width:100%"></label></div>
          <div style="margin-bottom:12px"><label>ìµœëŒ€ ì¸ì›<br><input id="roomMax" class="input" type="number" min="1" max="12" value="4" style="width:80px"></label></div>
          <div style="margin-bottom:12px"><label>AI ëª¨ë“œ<br>
            <select id="roomAIMode" class="input"><option value="queue">ìˆœì°¨ ë°œí™”(ê¸°ë³¸)</option><option value="free">ììœ  ë°œí™”</option></select>
          </label></div>
          <div style="margin-bottom:12px"><label>ê´€ì „ì í—ˆìš©(ëª…)<br><input id="roomSpec" class="input" type="number" min="0" max="20" value="0" style="width:80px"></label></div>
          <div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end;"><button id="roomCancel" class="btn">ì·¨ì†Œ</button><button id="roomCreate" class="btn primary">ë°© ë§Œë“¤ê¸°</button></div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('#roomCancel').onclick = () => modal.remove();
      modal.querySelector('#roomCreate').onclick = async () => {
        const title = modal.querySelector('#roomTitle').value.trim() || 'ìƒˆ ë°©';
        const desc = modal.querySelector('#roomDesc').value.trim();
        const maxPlayers = Math.max(1, Math.min(12, parseInt(modal.querySelector('#roomMax').value,10) || 4));
        const openSlots = Array.from({length:maxPlayers}, (_,i)=>i+1);
        const aiMode = modal.querySelector('#roomAIMode').value;
        const spectatorsMax = Math.max(0, Math.min(20, parseInt(modal.querySelector('#roomSpec').value,10)||0));
        try{
          const { room } = await API.create({ clientId: Store.state.clientId, title, desc, maxPlayers, openSlots, aiMode, spectatorsMax });
          location.href = 'room.html?room=' + encodeURIComponent(room.id);
        }catch(e){ alert('ë°© ìƒì„± ì‹¤íŒ¨: ' + (e?.message || e)); }
      };
    });

    // ì±„íŒ… ì „ì†¡
    function sendMessage() {
      const message = txt.value.trim();
      if (!message) return;
      txt.value = '';
      WS.chatSend('lobby', Store.state.name, message, 'general');
    }
    document.getElementById('send').addEventListener('click', sendMessage);
    txt.addEventListener('keypress', (e)=>{ if (e.key === 'Enter') sendMessage(); });

    // WS
    WS.connect();
    WS.on('LOBBY_STATE', (msg) => { (msg.chat||[]).forEach(c=> pushChat(c.name, c.text)); });
    WS.on('CHAT_PUSH', (msg) => {
  // í˜•íƒœê°€ ë‹¬ë¼ë„ ì¼ë‹¨ ì°ì–´ë³´ê¸°
  console.log('[CHAT_PUSH]', msg);

  const m = msg?.message || msg; // message ë˜í•‘ ì—†ì„ ê°€ëŠ¥ì„±ë„ ê³ ë ¤
  if (!m) return;

  // í…ŒìŠ¤íŠ¸ ê¸°ê°„ì—” roomId í•„í„° ì ê¹ ì™„í™” â€” ë¬¸ì œ í•´ê²°ë˜ë©´ ë‹¤ì‹œ 'lobby'ë§Œ í•„í„°
  if (!m.roomId || m.roomId === 'lobby') {
    pushChat(m.name || 'Player', m.text || '');
  }
});

    // ì´ˆê¸°í™”: join lobby, ìœ ë ¹ ë½ ì •ë¦¬, loadRooms
    WS.join('lobby', Store.state.clientId, Store.state.name);
    (async () => {
      const active = localStorage.getItem('RSK_ACTIVE_ROOM');
      if (!active) { await loadRooms(); return; }
      try{ await API.getRoom(active); } catch { localStorage.removeItem('RSK_ACTIVE_ROOM'); } finally { await loadRooms(); }
    })();
  </script>
</body>
</html>
