<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Room (Clean)</title>
  <style>
    :root { --gap: 12px; --b:#e5e7eb; --fg:#111827; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin:0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); }
    header { border-bottom:1px solid var(--b); padding:12px 16px; display:flex; align-items:center; gap:10px; }
    header h1 { margin:0; font-size:18px; }
    .container { display:grid; grid-template-columns: 1fr 320px; gap:var(--gap); padding:16px; }
    .card { border:1px solid var(--b); border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:8px; }
    .btn { border:1px solid var(--b); padding:6px 10px; border-radius:8px; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .btn.danger { background:#b91c1c; color:#fff; border-color:#b91c1c; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .input { border:1px solid var(--b); border-radius:8px; padding:6px 8px; width:100%; }
    ul.slots { list-style:none; padding:0; margin:0; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; }
    ul.slots li { border:1px solid var(--b); border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:6px; }
    .muted { color:var(--muted); }
    .chatlog { height: 240px; overflow:auto; border:1px solid var(--b); border-radius:8px; padding:8px; background:#fff; }
    .chatitem { margin:4px 0; }
    .meta { color:var(--muted); font-size:12px; }
    @media (max-width: 860px){ .container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <h1>🏰 Room</h1>
  <div class="row" style="margin-left:auto; gap:8px;">
    <a class="btn" href="lobby.html">로비로</a>
    <button id="leaveBtn" class="btn">탈퇴</button>
    <button id="deleteBtn" class="btn danger" style="display:none">방 삭제</button>
  </div>
</header>

<div class="container">
  <section class="col">
    <div id="meta" class="card"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>슬롯</strong>
        <span class="meta">내 ID: <code id="meId"></code></span>
      </div>
      <ul id="slotList" class="slots"></ul>
    </div>

    <div class="card col">
      <div class="row" style="gap:8px;">
        <input id="chatInput" class="input" placeholder="메시지를 입력하세요 (Enter)"/>
        <button id="chatSend" class="btn">전송</button>
      </div>
      <div id="chatLog" class="chatlog"></div>
    </div>
  </section>

  <aside class="col">
    <div class="card">
      <strong>호스트 컨트롤</strong>
      <div id="hostOnly" class="col" style="margin-top:8px; display:none;">
        <div class="row">
          <input id="speakerIn" class="input" placeholder="발화 슬롯 번호"/>
          <button id="speakerBtn" class="btn">발화자 지정</button>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button id="startBtn" class="btn primary">게임 시작</button>
        </div>
      </div>
      <div id="hostHint" class="meta">호스트가 아닙니다.</div>
    </div>
  </aside>
</div>

<script>
// ==== Minimal, dependency-free Room client ====

// 0) Boot endpoints (localStorage로 오버라이드 가능)
const DEFAULT_API_BASE = (localStorage.RSK_API_BASE) || 'https://raid-api.leeeeeeeeujin.workers.dev';
const DEFAULT_WS_URL   = (localStorage.RSK_WS_URL)   || 'wss://raid-api.leeeeeeeeujin.workers.dev/ws';
const API_BASE = DEFAULT_API_BASE;
const WS_URL   = DEFAULT_WS_URL;

// 1) Essentials
const roomId = new URLSearchParams(location.search).get('room');
if (!roomId) { alert('room 파라미터가 없습니다'); location.href = 'lobby.html'; }

let clientId = localStorage.getItem('RSK_CLIENT_ID');
if (!clientId) {
  clientId = (self.crypto?.randomUUID?.() || String(Math.random())).replace(/[^a-z0-9-]/gi, '');
  localStorage.setItem('RSK_CLIENT_ID', clientId);
}
const myName = localStorage.getItem('RSK_NAME') || 'Player';

// 2) DOM refs
const metaBox = document.getElementById('meta');
const meIdEl  = document.getElementById('meId');
const ulSlots = document.getElementById('slotList');
const leaveBtn = document.getElementById('leaveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const hostOnly  = document.getElementById('hostOnly');
const hostHint  = document.getElementById('hostHint');
const speakerIn = document.getElementById('speakerIn');
const speakerBtn= document.getElementById('speakerBtn');
const startBtn  = document.getElementById('startBtn');
const chatLog   = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');
const chatSend  = document.getElementById('chatSend');

meIdEl.textContent = clientId;

// 3) Helpers
const ensureArr = (v)=> Array.isArray(v) ? v : [];
function normalizeRoom(r){
  if (!r) return null;
  return {
    id: r.id,
    title: r.title || '방',
    desc: r.desc || '',
    hostId: r.hostId || null,
    status: r.status || 'lobby',
    aiMode: r.aiMode || '',
    speakerSlot: (r.speakerSlot==null||Number.isNaN(+r.speakerSlot))? null : Number(r.speakerSlot),
    boss: !!r.boss,
    slots: Array.isArray(r.slots) ? r.slots : [],
    ready: ensureArr(r.ready),
    muted: ensureArr(r.muted),
    banned: ensureArr(r.banned),
    lockedSlots: ensureArr(r.lockedSlots),
    promptAllowedSlots: ensureArr(r.promptAllowedSlots),
    roles: r.roles || {},
    pairs: r.pairs || {},
  };
}

function el(tag, attrs={}, ...children){
  const x = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==='class') x.className = v;
    else if (k==='style') x.setAttribute('style', v);
    else if (k.startsWith('on') && typeof v === 'function') x.addEventListener(k.slice(2), v);
    else x.setAttribute(k, v);
  });
  children.forEach(c=> x.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
  return x;
}

function logChat(name, text){
  const line = el('div', {class:'chatitem'}, el('strong',{}, name+': '), document.createTextNode(text));
  chatLog.appendChild(line);
  chatLog.scrollTop = chatLog.scrollHeight;
}

// 4) REST calls
async function getRoom(){
  const r = await fetch(`${API_BASE}/api/rooms/${roomId}`);
  if (!r.ok) throw new Error('room not found');
  const j = await r.json();
  return normalizeRoom(j.room || j);
}
async function claim(slotNo){
  await fetch(`${API_BASE}/api/rooms/${roomId}/claim`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ clientId, name: myName, slotNo })
  });
}
async function release(){
  await fetch(`${API_BASE}/api/rooms/${roomId}/release`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ clientId })
  });
}
async function delRoom(){
  await fetch(`${API_BASE}/api/rooms/${roomId}/delete`, { method:'POST' });
}
async function setSpeaker(slotNo){
  await fetch(`${API_BASE}/api/rooms/${roomId}/speaker`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ clientId, slotNo })
  });
}
async function startGame(){
  await fetch(`${API_BASE}/api/rooms/${roomId}/start`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ clientId })
  });
}

// 5) WS minimal client
let sock = null;
function wsConnect(){
  try {
    sock = new WebSocket(WS_URL);
    sock.addEventListener('open', () => {
      // join → then ready to chat
      safeSend({ type:'join', roomId, name: myName, clientId });
    });
    sock.addEventListener('message', (e) => {
      let msg; try { msg = JSON.parse(e.data); } catch { return; }
      if (msg?.type === 'CHAT_PUSH' && msg.message?.roomId === roomId) {
        const m = msg.message;
        logChat(m.name || 'Player', m.text || '');
      }
      if (msg?.type === 'ROOM_STATE' && msg.room?.id === roomId) {
        render(normalizeRoom(msg.room));
      }
    });
    sock.addEventListener('close', () => { /* optionally reconnect */ });
    sock.addEventListener('error', () => { /* noop */ });
  } catch(e){ console.warn('WS connect error', e); }
}
function safeSend(obj){
  try{ sock && sock.readyState===1 && sock.send(JSON.stringify(obj)); }catch{}
}

// 6) Render
async function refresh(){
  try {
    const room = await getRoom();
    render(room);
  } catch(e){
    console.error('방 로드 실패:', e);
    alert('방을 찾을 수 없습니다.');
    location.href = 'lobby.html';
  }
}

function render(room){
  const isHost = (room.hostId === clientId);
  deleteBtn.style.display = isHost ? 'inline-block' : 'none';
  hostOnly.style.display = isHost ? 'flex' : 'none';
  hostHint.style.display = isHost ? 'none' : 'block';

  metaBox.innerHTML = `
    <div class="row" style="justify-content:space-between;">
      <strong>${room.title}</strong>
      <span class="meta">상태: ${room.status} · 발화자: ${room.speakerSlot ?? '-'}</span>
    </div>
    <div class="meta">${room.desc || ''}</div>
  `;

  // slots
  ulSlots.innerHTML = '';
  const myOwnedSlot = (room.slots||[]).find(s => s.clientId === clientId) || null;

  (room.slots || []).forEach(s => {
    const busy = !!(s.clientId || s.playerId);
    const isMine = !!(s.clientId === clientId);
    const li = el('li', {},
      el('div', {class:'row', style:'justify-content:space-between;'},
        el('div', {}, `#${s.slotNo}`),
        el('div', {class:'meta'}, room.roles?.[s.slotNo] || '')
      ),
      el('div', {class:'col'},
        el('div', {class: busy ? '' : 'muted'}, busy ? (s.name || 'Player') : '비어있음')
      ),
      el('div', {class:'row', style:'justify-content:flex-end;'},
        (!busy ? el('button', {class:'btn', onclick: async()=>{ await claim(s.slotNo); refresh(); }}, '참가')
               : (isMine ? el('button', {class:'btn', onclick: async()=>{ await release(); refresh(); }}, '탈퇴')
                         : el('button', {class:'btn', disabled:true}, '사용중')))
      )
    );
    ulSlots.appendChild(li);
  });

  // chat input enabled
  chatInput.disabled = false;
  chatSend.disabled  = false;
}

// 7) UI handlers
leaveBtn.addEventListener('click', async () => {
  const ok = confirm('이 방에서 나가시겠습니까?');
  if (!ok) return;
  await release().catch(()=>{});
  location.href = 'lobby.html';
});
deleteBtn.addEventListener('click', async () => {
  const ok = confirm('정말 방을 삭제할까요? (되돌릴 수 없음)');
  if (!ok) return;
  await delRoom().catch(()=>{});
  location.href = 'lobby.html';
});
speakerBtn.addEventListener('click', async () => {
  const n = parseInt(speakerIn.value, 10);
  if (!Number.isFinite(n)) return alert('숫자를 입력하세요');
  await setSpeaker(n).catch(e=> alert('실패: '+(e?.message||e)));
  refresh();
});
startBtn.addEventListener('click', async () => {
  await startGame().catch(()=>{});
  refresh();
});

function sendChat(){
  const text = (chatInput.value || '').trim();
  if (!text) return;
  chatInput.value = '';
  safeSend({ type:'chat', roomId, name: myName, text, kind:'room' });
}
chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') sendChat(); });

// boot
wsConnect();
refresh();
</script>
</body>
</html>
