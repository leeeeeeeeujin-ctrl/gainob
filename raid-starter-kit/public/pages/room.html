<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë°© - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
<link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h1 style="margin: 0; font-size: 24px;">ğŸ° Raid Room</h1>
        </div>
        <div class="row">
          <a href="lobby.html" class="btn">ë¡œë¹„ë¡œ</a>
          <button id="leaveRoom" class="btn danger">íƒˆí‡´</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 450px;">
    <section>
      <div id="aiChat"></div>
      <div style="height: 16px;"></div>
      <div id="genChat"></div>
    </section>

    <aside>
      <div id="roomMeta" class="card"></div>
      <div style="height: 16px;"></div>
      <div id="slots"></div>
      <div style="height: 16px;"></div>
      <div class="card" id="hostCtrl" style="display: none;">
        <h4>í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤</h4>
        <div class="row" style="margin-bottom: 8px; align-items:center;">
          <label class="meta" style="min-width:84px">í”„ë¡¬í”„íŠ¸</label>
          <select id="promptSel" class="input" style="max-width: 260px"></select>
          <a href="prompt.html" class="btn">í¸ì§‘</a>
        </div>
        <div class="row" style="margin-bottom: 8px; align-items:center;">
          <label class="meta" style="min-width:84px">API í‚¤</label>
          <input id="apiKey" class="input" placeholder="Gemini API Key" style="max-width: 260px">
          <button id="saveKey" class="btn">ì €ì¥</button>
        </div>
        <div class="card" style="margin-bottom:8px">
          <b>ë¯¸ë¦¬ë³´ê¸°</b>
          <pre id="promptPreview" class="mono" style="white-space:pre-wrap; max-height:160px; overflow:auto; margin-top:6px"></pre>
        </div>
        <div class="row" style="margin-bottom: 8px;">
          <input id="speaker" class="input" placeholder="ë°œí™” ìŠ¬ë¡¯ (ìˆ«ì)" style="max-width: 150px;">
          <button id="setSp" class="btn">ë°œí™”ì ì§€ì •</button>
        </div>
        <div class="row">
          <button id="runPrompt" class="btn">í”„ë¡¬í”„íŠ¸ ì‹¤í–‰</button>
        </div>
      </div>
    </aside>
  </div>

  <script type="module">
    import { Store } from '../core/store.js';
    import { API } from '../core/api.js';
    import { WS } from '../core/ws.js';
    import { mountGeneralChat } from '../components/chat-general.js';
    import { mountAiChat } from '../components/chat-ai.js';
    import { mountSlotsGrid } from '../components/slots-grid.js';
let __COUNTDOWN_ETD = 0;      // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¢…ë£Œ ì˜ˆì • ì‹œê° (ms)
let __COUNTDOWN_TIMER = null; // í´ë°± íƒ€ì´ë¨¸ í•¸ë“¤
// ì„œë²„ì—ì„œ AI íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
async function fetchAiHistory(roomId, n = 40) {
  const r = await fetch(`/api/rooms/${roomId}/history?n=${n}`);
  if (!r.ok) throw new Error('history HTTP ' + r.status);
  const j = await r.json();
  return Array.isArray(j.history) ? j.history : [];
}

// íˆìŠ¤í† ë¦¬ â†’ Gemini contents ë³€í™˜
function historyToContents(history, newUserText) {
  const contents = [];
  for (const h of history) {
    if (!h || !h.text) continue;
    const role = (h.role === 'model') ? 'model' :
                 (h.role === 'system') ? 'system' : 'user';
    contents.push({ role, parts: [{ text: h.text }] });
  }
  if (newUserText && newUserText.trim()) {
    contents.push({ role: 'user', parts: [{ text: newUserText }] });
  }
  return contents;
}


    // AI ì±„ë„ íŒë³„(ì„œë²„ êµ¬í˜„ ì°¨ì´ í¡ìˆ˜)
    const isAiChannel = (msg) =>
      (msg?.kind === 'ai') ||
      (msg?.channel === 'ai') ||
      (msg?.to === 'ai') ||
      (msg?.tab === 'ai');

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°© ID ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(location.search);
    const roomId = params.get('room');
    let __AI_BUSY = false;   // ìë™ì‘ë‹µ ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸

    // ì´ë¯¸ ë‹¤ë¥¸ ë°©ì— ë½ì´ ìˆìœ¼ë©´ ì§„ì… ì°¨ë‹¨
    const active = localStorage.getItem('RSK_ACTIVE_ROOM');
    if (active && active !== roomId) {
      alert('ë‹¤ë¥¸ ë°©ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ê·¸ ë°©ì—ì„œ íƒˆí‡´í•˜ì„¸ìš”.');
      location.href = 'lobby.html';
      throw new Error('locked');
    }
    // ì´ ë°©ì„ í˜„ì¬ ë½ìœ¼ë¡œ ì„¤ì •
    localStorage.setItem('RSK_ACTIVE_ROOM', roomId);
    
    if (!roomId) {
      alert('ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤');
      location.href = 'lobby.html';
    }

    const clientId = Store.state.clientId;
    const myName = () => Store.state.name;

    // WebSocket ì—°ê²°
    WS.connect();
    WS.join(roomId, clientId, myName());

    // ì±„íŒ… ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸
    const genChat = mountGeneralChat(document.getElementById('genChat'), {
      roomId,
      clientId,
      nameGetter: myName
    });

    const aiChat = mountAiChat(document.getElementById('aiChat'), {
      roomId,
      clientId,
      nameGetter: myName
    });

    // ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ ë§ˆìš´íŠ¸
    const slotsGrid = mountSlotsGrid(document.getElementById('slots'), {
      host: false,
      async onClaim(slotNo) {
        const char = Store.state.roster[0] || null;
        if (!char) {
          alert('ë¡œìŠ¤í„°ì— ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìºë¦­í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
          return;
        }
        try {
          await API.claim(roomId, {
            clientId,
            name: myName(),
            slotNo,
            char
          });
          refresh();
        } catch (error) {
          alert('ìŠ¬ë¡¯ ì ìœ  ì‹¤íŒ¨: ' + error.message);
        }
      },
      async onRelease() {
        try {
          await API.release(roomId, { clientId });
          refresh();
        } catch (error) {
          alert('ìŠ¬ë¡¯ í•´ì œ ì‹¤íŒ¨: ' + error.message);
        }
      },
      async onReady() {
        try {
          await API.ready(roomId, { clientId });
          refresh();
        } catch (error) {
          alert('ì¤€ë¹„ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
        }
      },
      async onKick(slotNo) {
        if (!confirm('ì´ í”Œë ˆì´ì–´ë¥¼ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
          await API.kick(roomId, { clientId, targetSlot: slotNo });
          refresh();
        } catch (error) {
          alert('ì¶”ë°© ì‹¤íŒ¨: ' + error.message);
        }
      },
    });

    const metaBox = document.getElementById('roomMeta');
    const hostBox = document.getElementById('hostCtrl');
    const promptSel = document.getElementById('promptSel');
    const promptPreview = document.getElementById('promptPreview');
    const apiKeyInput = document.getElementById('apiKey');
    const saveKeyBtn = document.getElementById('saveKey');

    // ë°© ì •ë³´ ìƒˆë¡œê³ ì¹¨
    async function refresh() {
      try {
        const { room } = await API.getRoom(roomId);
        render(room);
      } catch (error) {
        localStorage.removeItem('RSK_ACTIVE_ROOM'); // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì´ë©´ ë½ ì •ë¦¬
        console.error('ë°©ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤:', error);
      }
    }

    function render(room) {
      metaBox.innerHTML = `
        <h4>${room.title}</h4>
        <div class="meta">${room.desc}</div>
        <div class="meta">ìƒíƒœ: ${room.status} Â· ëª¨ë“œ: ${room.aiMode} Â· ë°œí™”ì: ${room.speakerSlot}</div>
      `;

      // í˜¸ìŠ¤íŠ¸ í”Œë˜ê·¸ + ë²„íŠ¼ ë¼ë²¨
      window.IS_HOST = (room.hostId === clientId);
      const leaveBtn = document.getElementById('leaveRoom');
      if (leaveBtn) {
        leaveBtn.textContent = window.IS_HOST ? 'ë°© ì¢…ë£Œ(ì‚­ì œ)' : 'íƒˆí‡´';
      }

      // â‘  ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ ë Œë”
      slotsGrid.render(room, clientId);

      // â‘¡ í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ì˜ì—­ í‘œì‹œ/ì´ˆê¸°í™”
      const isHost = room.hostId === clientId;
      slotsGrid.setHost(isHost);
      hostBox.style.display = isHost ? 'block' : 'none';
      if (isHost) {
        const prompts = Store.loadPrompts();
        promptSel.innerHTML =
          (prompts || []).map(p => `<option value="${p.id}">${p.label || p.id}</option>`).join('')
          || '<option value="">(ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ì—†ìŒ)</option>';
        const last = localStorage.getItem('RSK_ROOM_PROMPT_' + room.id) || '';
        promptSel.value = last;
        apiKeyInput.value = localStorage.getItem('RSK_ROOM_APIKEY_' + room.id) || '';
        updatePreview(room);
      }

      // â‘¢ AI ì±„íŒ… ë°œí™”ê¶Œ ì—…ë°ì´íŠ¸
      const mySlot = room.slots.find(s => (s.playerId || s.clientId) === clientId);
      const canSpeak = isHost || room.aiMode === 'free' || room.speakerSlot === mySlot?.slotNo;
      aiChat.updateSpeak(canSpeak, room.aiMode, room.speakerSlot);

     // â”€â”€ [êµì²´] ê²Œì„ ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼ ìƒíƒœ ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const startBtn = hostBox.querySelector('#start');
if (startBtn) {
  const occupied = (room.slots || []).filter(s => (s?.playerId || s?.clientId));
  const allReady = occupied.length > 0 && occupied.every(s => !!s.ready);
  const st = String(room.status || '').toLowerCase();
  const running = ['running', 'playing', 'started', 'active', 'in-progress'].includes(st);

  // ì§„í–‰ ì¤‘ì´ë©´: 'ê²Œì„ ì¤‘ì§€'(í•­ìƒ í™œì„±)
  // ì§„í–‰ ì „ì´ë©´: 'ê²Œì„ ì‹œì‘'(ëª¨ë‘ ì¤€ë¹„ì¼ ë•Œë§Œ í™œì„±)
  startBtn.textContent = running ? 'ê²Œì„ ì¤‘ì§€' : 'ê²Œì„ ì‹œì‘';
  startBtn.disabled   = running ? false : !allReady;
  startBtn.title      = running
    ? 'ê²Œì„ì„ ì¤‘ì§€í•˜ê³  ìŠ¬ë¡¯ ì ê¸ˆì„ í•´ì œí•©ë‹ˆë‹¤'
    : (allReady ? '' : 'ëª¨ë“  ì°¸ê°€ìê°€ ì¤€ë¹„ ì™„ë£Œí•´ì•¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
}

    } // render ë

    // í˜¸ìŠ¤íŠ¸ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
    promptSel?.addEventListener('change', () => {
      localStorage.setItem('RSK_ROOM_PROMPT_'+roomId, promptSel.value || '');
      updatePreviewCache();
    });

    saveKeyBtn?.addEventListener('click', () => {
      localStorage.setItem('RSK_ROOM_APIKEY_'+roomId, (apiKeyInput.value||'').trim());
      alert('API í‚¤ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤ (ë¡œì»¬)');
    });

    function updatePreviewCache(){
      // ìµœì‹  ë°© ìƒíƒœë¡œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
      API.getRoom(roomId).then(({room})=> updatePreview(room)).catch(()=>{});
    }

    function updatePreview(room){
      const prompts = Store.loadPrompts();
      const cur = prompts.find(p => p.id === (promptSel.value||''));
      if (!cur){ promptPreview.textContent = ''; return; }
      promptPreview.textContent = expandTemplate(cur.text||'', room);
    }

    // í…œí”Œë¦¿ ì¹˜í™˜ê¸°
    function expandTemplate(tpl, room){
      function getSlot(n){ return room.slots?.find(s=>s.slotNo===n) || {}; }
      function charAll(c){ if(!c) return ''; const lines=[]; lines.push(`${c.name||''}`); if(c.title) lines.push(`- ${c.title}`); if(c.desc) lines.push(c.desc); (c.abilities||[]).forEach((a,i)=>{ if(a?.name||a?.text) lines.push(`â€¢ (${i+1}) ${a.name||''} â€” ${a.text||''}`); }); return lines.filter(Boolean).join('\n'); }
      return (tpl||'').replace(/\{\{\s*([\w.\[\]]+)\s*\}\}/g, (_, key)=>{
        if(key.startsWith('slot')){
          const m = key.match(/^slot(\d+)\.(.+)$/); if(!m) return '';
          const n = parseInt(m[1],10); const rest=m[2]; const slot=getSlot(n); const c=slot.char||{};
          if(rest==='char.all') return charAll(c);
          if(rest.startsWith('char.abilities[')){
            const mm = rest.match(/^char\.abilities\[(\d+)\]\.(name|text)$/); if(!mm) return '';
            const idx=parseInt(mm[1],10)-1; const field=mm[2]; return c.abilities?.[idx]?.[field]||'';
          }
          const map={ 'char.name':c.name,'char.desc':c.desc,'char.title':c.title };
          return map[rest]||'';
        }
        if (key.startsWith('me.')) {
          const mySlot = room.slots.find(s => (s.playerId || s.clientId) === clientId);
          return expandTemplate(`{{slot${mySlot?.slotNo||1}.${key.slice(3)}}}`, room);
        }
        if(key==='room.title') return room.title||'';
        if(key==='room.desc') return room.desc||'';
        return '';
      });
    }

async function callGemini(apiKey, contentsOrText){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(apiKey)}`;
  const contents = Array.isArray(contentsOrText)
    ? contentsOrText
    : [{ role:'user', parts:[{ text: String(contentsOrText||'') }] }];
  const body = { contents };
  const r = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  const out = j?.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('\n') || '(ë¹ˆ ì‘ë‹µ)';
  return out;
}

    document.getElementById('runPrompt')?.addEventListener('click', async () => {
      const prompts = Store.loadPrompts();
      const cur = prompts.find(p => p.id === (promptSel.value||''));
      if (!cur) { alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
      const key = (apiKeyInput.value||'').trim() || localStorage.getItem('RSK_ROOM_APIKEY_'+roomId) || '';
      if (!key) { alert('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      try{
        // ë°© ìƒíƒœ ê°€ì ¸ì™€ ì¹˜í™˜
        const { room } = await API.getRoom(roomId);
        const expanded = expandTemplate(cur.text||'', room);
        const resp = await callGemini(key, expanded);
        await API.runPrompt(roomId, { clientId, text: resp });
      }catch(e){
        alert('í”„ë¡¬í”„íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨: '+e.message);
      }
    });

    hostBox.querySelector('#setSp').onclick = async () => {
      const slotNo = parseInt(hostBox.querySelector('#speaker').value, 10);
      if (!slotNo) return;
      
      try {
        await API.speaker(roomId, { clientId, slotNo });
        refresh();
      } catch (error) {
        alert('ë°œí™”ì ì§€ì • ì‹¤íŒ¨: ' + error.message);
      }
    };




    // WebSocket ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    WS.on('ROOM_STATE', (message) => {
      if (message.room?.id === roomId) {
        render(message.room);
      }
    });

    WS.on('CHAT_PUSH', async (message) => {
      const msg = message.message;
      if (!msg || msg.roomId !== roomId) return;

      // 1) í™”ë©´ ë¡œê·¸ëŠ” ê¸°ì¡´ëŒ€ë¡œ
      if (isAiChannel(msg)) {
        aiChat.log.push(msg.name, msg.text);
      } else {
        genChat.push(msg.name, msg.text);
        return; // â˜… ì¼ë°˜ ì±„ë„ì€ ì—¬ê¸°ì„œ ë â€” ê±´ë“¤ì§€ ì•ŠìŒ
      }

      // 2) ë£¨í”„ ë°©ì§€: AI/ì‹œìŠ¤í…œì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ
      if (/^(?:\[?AI\]?|SYSTEM)$/i.test(msg.name || '')) return;

      // 3) ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ ë°©ì§€
      if (__AI_BUSY) return;

      // 4) í‚¤ ì—†ìœ¼ë©´ ì¡°ìš©íˆ íŒ¨ìŠ¤
      const key =
        (apiKeyInput.value || '').trim() ||
        localStorage.getItem('RSK_ROOM_APIKEY_' + roomId) || '';
      if (!key) { console.warn('[AI] API í‚¤ ì—†ìŒ'); return; }

try {
  __AI_BUSY = true;

  // 1) ì„œë²„ì—ì„œ ìµœê·¼ íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
  const history = await fetchAiHistory(roomId, 40);

  // 2) ì‚¬ìš©ìê°€ ë°©ê¸ˆ ì¹œ í…ìŠ¤íŠ¸ì— í…œí”Œë¦¿ ì¹˜í™˜ ì ìš©
  let promptText = msg.text || '';
  try {
    const { room } = await API.getRoom(roomId);
    promptText = expandTemplate(promptText, room);
  } catch (_) {}

  // 3) íˆìŠ¤í† ë¦¬ + ìƒˆ ì…ë ¥ì„ contentsë¡œ êµ¬ì„±
  const contents = historyToContents(history, promptText);

  // 4) ëª¨ë¸ í˜¸ì¶œ
  const key =
    (apiKeyInput.value || '').trim() ||
    localStorage.getItem('RSK_ROOM_APIKEY_' + roomId) || '';
  if (!key) { console.warn('[AI] API í‚¤ ì—†ìŒ'); return; }

  const resp = await callGemini(key, contents);

  // 5) ëª¨ë¸ ì‘ë‹µì„ ì„œë²„ì— ê¸°ë¡(= model ì—­í•  ì €ì¥ + ë¸Œë¡œë“œìºìŠ¤íŠ¸)
  await fetch(`/api/rooms/${roomId}/chat/ai`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text: resp })
  });
} catch (e) {
  console.warn('[AI] ìë™ì‘ë‹µ ì‹¤íŒ¨:', e);
} finally {
  __AI_BUSY = false;
}

    });
WS.on('COUNTDOWN_TICK', (message) => {
  genChat.sys('ê²Œì„ ì‹œì‘ê¹Œì§€ ' + message.n + 'ì´ˆ...');
  const startBtn = hostBox.querySelector('#start');
  if (startBtn) { startBtn.textContent = `ì¹´ìš´íŠ¸ë‹¤ìš´ ${message.n}ì´ˆ...`; startBtn.disabled = true; startBtn.title = 'ì¹´ìš´íŠ¸ë‹¤ìš´ ì¤‘'; }
});

WS.on('COUNTDOWN_DONE', (message) => {
  refresh();
  const startBtn = hostBox.querySelector('#start');
  if (startBtn) { startBtn.textContent = 'ê²Œì„ ì¤‘ì§€'; startBtn.disabled = false; startBtn.title = 'ê²Œì„ì„ ì¤‘ì§€í•˜ê³  ìŠ¬ë¡¯ ì ê¸ˆì„ í•´ì œí•©ë‹ˆë‹¤'; }
});


    // ì´ˆê¸°í™”
    refresh();

    // íƒˆí‡´/ë°© ì¢…ë£Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    document.getElementById('leaveRoom')?.addEventListener('click', async () => {
      if (window.IS_HOST) {
        if (!confirm('ì •ë§ ì´ ë°©ì„ ì¢…ë£Œ(ì‚­ì œ)í• ê¹Œìš”?')) return;
        try {
          // â‘  ì¢…ë£Œ ì•ˆë‚´ ì±„íŒ… ì „ì†¡
          try {
            if (API.chat) {
              await API.chat(roomId, { name: '[SYSTEM]', text: 'ë°©ì´ ì¢…ë£Œë©ë‹ˆë‹¤.' });
            } else if (WS.emit) {
              WS.emit('CHAT', { roomId, message: { name: '[SYSTEM]', text: 'ë°©ì´ ì¢…ë£Œë©ë‹ˆë‹¤.' } });
            } else {
              await fetch(`/api/rooms/${roomId}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: '[SYSTEM]', text: 'ë°©ì´ ì¢…ë£Œë©ë‹ˆë‹¤.' })
              });
            }
          } catch (e) {
            console.warn('ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', e);
          }

          // â‘¡ ì ê¹ ëŒ€ê¸° (ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì—¬ìœ )
          await new Promise(r => setTimeout(r, 200));

          // â‘¢ í˜¸ìŠ¤íŠ¸ëŠ” ë°© ì‚­ì œ í˜¸ì¶œ
          if (API.deleteRoom) {
            await API.deleteRoom(roomId, { clientId });
          } else {
            const res = await fetch(`/api/rooms/${roomId}/delete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ clientId })
            });
            if (!res.ok) throw new Error('ë°© ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch (e) {
          alert('ë°© ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
          return;
        }
      } else {
        if (!confirm('ì´ ë°©ì—ì„œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
          // ì¼ë°˜ ì°¸ê°€ìëŠ” ìŠ¬ë¡¯ í•´ì œë§Œ
          try { await API.release(roomId, { clientId }); } catch (_) {}
        } catch (e) {
          alert('íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
          return;
        }
      }

      // ê³µí†µ ì •ë¦¬: ë½ í•´ì œ í›„ ë¡œë¹„ë¡œ
      localStorage.removeItem('RSK_ACTIVE_ROOM');
      location.href = 'lobby.html';
    });
  </script>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í”„ë¡¬í”„íŠ¸ í¸ì§‘ê¸° - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
<link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <b>í”„ë¡¬í”„íŠ¸ í¸ì§‘ê¸°</b>
        <div class="row">
          <a href="lobby.html" class="btn">ë¡œë¹„</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 380px;">
    <section class="card" id="editorBox">
      <div class="row" style="justify-content: space-between;">
        <div><b>í”„ë¡¬í”„íŠ¸ ëª©ë¡</b></div>
        <div>
          <button id="addPrompt" class="btn">ìƒˆ í”„ë¡¬í”„íŠ¸</button>
          <button id="delPrompt" class="btn danger">ì‚­ì œ</button>
        </div>
      </div>
      <select id="promptList" class="input" style="margin-top:8px"></select>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <b>ë‚´ìš©</b>
          <input id="promptLabel" class="input" placeholder="ë¼ë²¨" style="max-width: 240px;">
        </div>
        <textarea id="promptText" class="input mono" rows="10" placeholder="ì—¬ê¸°ì— í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="margin-top:8px"></textarea>
        <div class="row" style="justify-content: flex-end; margin-top:8px">
          <button id="savePrompt" class="btn primary">ì €ì¥</button>
        </div>
      </div>
    </section>

    <aside class="card" id="varsBox">
      <b>ë³€ìˆ˜ íŒ”ë ˆíŠ¸</b>
      <div class="meta" style="margin-top:6px">í•­ëª©ì„ ì„ íƒí•˜ë©´ í…ìŠ¤íŠ¸ì— í•´ë‹¹ ë³€ìˆ˜ê°€ ì‚½ì…ë©ë‹ˆë‹¤.</div>

      <div class="card" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b>ìºë¦­í„°</b>
          <span class="meta" id="selSlotHint">ì„ íƒ ìŠ¬ë¡¯: 1</span>
        </div>
        <div id="slotsRow" class="row" style="flex-wrap:wrap;gap:6px;margin-top:6px"></div>
        <div id="charFields" class="row" style="flex-wrap:wrap;gap:6px;margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:8px">
        <b>ë°©</b>
        <div id="roomFields" class="row" style="flex-wrap:wrap;gap:6px;margin-top:8px"></div>
      </div>
    </aside>
  </div>

  <script type="module">
    import { Store } from '../core/store.js';

    // ìƒíƒœ
    let list = Store.loadPrompts();
    let curId = list[0]?.id || '';

    // ì—˜ë¦¬ë¨¼íŠ¸
    const sel = document.getElementById('promptList');
    const txt = document.getElementById('promptText');
    const label = document.getElementById('promptLabel');
    const slotsRow = document.getElementById('slotsRow');
    const charFields = document.getElementById('charFields');
    const roomFields = document.getElementById('roomFields');
    const selSlotHint = document.getElementById('selSlotHint');
    let selectedSlot = 1;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ë Œë”ëŸ¬ (ë‹¨ì¼)
    function render() {
      // í•­ìƒ ìµœì‹  ëª©ë¡ ë¡œë“œ
      list = Store.loadPrompts();

      // 1) ëª©ë¡ ì±„ìš°ê¸°
      sel.innerHTML = (list || []).map(p => `<option value="${p.id}">${p.label || p.id}</option>`).join('');

      // 2) í˜„ì¬ ì„ íƒê°’ ë³´ì •
      if (!curId || !list.some(p => p.id === curId)) {
        curId = list[0]?.id || '';
      }
      sel.value = curId || '';

      // 3) ìƒì„¸ ë°˜ì˜
      const cur = list.find(p => p.id === curId);
      txt.value = cur?.text || '';
      label.value = cur?.label || '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ìŠ¬ë¡¯/ë³€ìˆ˜ íŒ”ë ˆíŠ¸ (ì´ˆê¸°í™” 1íšŒ)
    function initSlots() {
      // ìŠ¬ë¡¯ ë²„íŠ¼: 1íšŒ ë Œë”, í´ë¦­ ì‹œ class í† ê¸€ë§Œ
      slotsRow.innerHTML = Array.from({length:12}, (_, i) => {
        const n = i + 1;
        return `<button class="btn${n===selectedSlot ? ' primary' : ''}" data-slot="${n}">${n}</button>`;
      }).join('');

      slotsRow.addEventListener('click', (e) => {
        const n = parseInt(e.target?.dataset?.slot || '', 10);
        if (!n || n === selectedSlot) return;
        selectedSlot = n;
        selSlotHint.textContent = `ì„ íƒ ìŠ¬ë¡¯: ${n}`;
        // í† ê¸€
        slotsRow.querySelectorAll('button').forEach(b => {
          const bn = parseInt(b.dataset.slot, 10);
          b.classList.toggle('primary', bn === selectedSlot);
        });
      });

      // ìºë¦­í„° í•„ë“œ(ì •ì )
      const charFieldDefs = [
        { label:'ì´ë¦„',   build:(n)=>`{{slot${n}.char.name}}` },
        { label:'ì„¤ëª…',   build:(n)=>`{{slot${n}.char.desc}}` },
        { label:'ëŠ¥ë ¥1',  build:(n)=>`{{slot${n}.char.abilities[1].name}} â€” {{slot${n}.char.abilities[1].text}}` },
        { label:'ëŠ¥ë ¥2',  build:(n)=>`{{slot${n}.char.abilities[2].name}} â€” {{slot${n}.char.abilities[2].text}}` },
        { label:'ëŠ¥ë ¥3',  build:(n)=>`{{slot${n}.char.abilities[3].name}} â€” {{slot${n}.char.abilities[3].text}}` },
        { label:'ëŠ¥ë ¥4',  build:(n)=>`{{slot${n}.char.abilities[4].name}} â€” {{slot${n}.char.abilities[4].text}}` },
        { label:'ëª¨ë‘',   build:(n)=>`{{slot${n}.char.all}}` },
      ];
      charFields.innerHTML = charFieldDefs.map((f, i) => `<button class="btn" data-idx="${i}">${f.label}</button>`).join('');
      charFields.addEventListener('click', (e) => {
        const idx = parseInt(e.target?.dataset?.idx || '', 10);
        if (Number.isNaN(idx)) return;
        insertAtCursor(charFieldDefs[idx].build(selectedSlot));
      });

      // ë°© í•„ë“œ(ì •ì )
      const roomFieldDefs = [
        { label:'ì œëª©', tag:'{{room.title}}' },
        { label:'ì„¤ëª…', tag:'{{room.desc}}' },
      ];
      roomFields.innerHTML = roomFieldDefs.map((f, i) => `<button class="btn" data-room="${i}">${f.label}</button>`).join('');
      roomFields.addEventListener('click', (e) => {
        const idx = parseInt(e.target?.dataset?.room || '', 10);
        if (Number.isNaN(idx)) return;
        insertAtCursor(roomFieldDefs[idx].tag);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì¡°ì‘(ì¶”ê°€/ì‚­ì œ/ì €ì¥) â€” Storeì˜ ë‹¨ê±´ API ì‚¬ìš©
    document.getElementById('addPrompt').onclick = () => {
      const id = Store.addPrompt({ label: 'ìƒˆ í”„ë¡¬í”„íŠ¸', text: '' });
      curId = id;
      render();
    };

    document.getElementById('delPrompt').onclick = () => {
      if (!curId) return;
      if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
      Store.removePrompt(curId);
      const next = Store.loadPrompts();
      curId = next[0]?.id || '';
      render();
    };

    document.getElementById('savePrompt').onclick = () => {
      if (!curId) return;
      Store.updatePrompt(curId, {
        label: (label.value || '').trim() || 'í”„ë¡¬í”„íŠ¸',
        text: txt.value || ''
      });
      render();
      alert('ì €ì¥í–ˆìŠµë‹ˆë‹¤');
    };

    // ì„ íƒ ë³€ê²½
    sel.onchange = () => { curId = sel.value; render(); };

    // í…ìŠ¤íŠ¸ ì‚½ì… ìœ í‹¸
    function insertAtCursor(text) {
      const start = txt.selectionStart || 0;
      const end = txt.selectionEnd || start;
      const value = txt.value || '';
      txt.value = value.slice(0, start) + text + value.slice(end);
      txt.focus();
      txt.selectionStart = txt.selectionEnd = start + text.length;
    }

    // ì´ˆê¸°í™”
    initSlots();
    render();
  </script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>

</body>
</html>
