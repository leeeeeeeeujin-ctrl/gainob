<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë¡œë¹„ - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
<link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <div>
          <h1 style="margin: 0; font-size: 24px;">ğŸ° Raid Lobby</h1>
        </div>
        <div class="row">
          <input id="myName" class="input" style="max-width: 200px;" placeholder="í”Œë ˆì´ì–´ ì´ë¦„">
          <a href="character.html" class="btn">ìºë¦­í„° ìƒì„±</a>
          <a href="roster.html" class="btn">ë¡œìŠ¤í„°</a>
          <a href="prompt.html" class="btn">í”„ë¡¬í”„íŠ¸</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 400px;">
    <section class="card">
      <div class="row" style="justify-content: space-between;">
        <h3>ë°© ëª©ë¡</h3>
        <button id="mk" class="btn primary">ë°© ë§Œë“¤ê¸°</button>
      </div>
      <div id="rooms" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 16px;"></div>
    </section>

    <aside class="card">
      <h3>ë¡œë¹„ ì±„íŒ…</h3>
      <div id="log" style="height: 300px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: #fafafa; margin-bottom: 8px;"></div>
      <div class="row">
        <input id="txt" class="input grow" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="send" class="btn primary">ì „ì†¡</button>
      </div>
    </aside>
  </div>

  <script type="module">
    import { Store } from '../core/store.js';
    import { API } from '../core/api.js';
    import { WS } from '../core/ws.js';

    const roomsBox = document.getElementById('rooms');
    const nameInput = document.getElementById('myName');
    const log = document.getElementById('log');
    const txt = document.getElementById('txt');

    // ì´ë¦„ ì„¤ì •
    nameInput.value = Store.state.name;
    nameInput.addEventListener('change', () => {
      Store.setName(nameInput.value.trim() || 'Player');
    });

async function loadRooms() {
  try {
    const active = localStorage.getItem('RSK_ACTIVE_ROOM'); // â˜… ë½ í‚¤
    const clientId = Store.state.clientId;
    const { rooms } = await API.listRooms();

    roomsBox.innerHTML = rooms.map(room => {
      const isActive = active && room.id === active;
      const locked   = !!active && !isActive; // ë‹¤ë¥¸ ë°©ì€ ì ê¸ˆ

      const actionHtml = isActive
        ? `<a class="btn" href="room.html?room=${room.id}">ì°¸ì—¬ì¤‘ Â· ì¬ì…ì¥</a>`
        : (locked
            ? `<button class="btn" disabled title="ë‹¤ë¥¸ ë°©ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤">ì°¸ê°€í•˜ê¸°</button>`
            : `<a class="btn primary" href="room.html?room=${room.id}">ì°¸ê°€í•˜ê¸°</a>`);

      return `
        <div class="card">
          <h4>${room.title}</h4>
          <div class="meta">${room.players}/${room.max}ëª… Â· ${room.boss ? 'ë³´ìŠ¤ ìˆìŒ' : 'ë³´ìŠ¤ ì—†ìŒ'} Â· ${room.status}</div>
          <div class="row" style="margin-top:8px;">
            ${actionHtml}
          </div>
        </div>
      `;
    }).join('') || '<div class="meta">ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';

    // â€œë°© ë§Œë“¤ê¸°â€ ë²„íŠ¼ë„ ì ê¸ˆ
    const mk = document.getElementById('mk');
    if (mk) {
      if (active) {
        mk.disabled = true;
        mk.title = 'ë‹¤ë¥¸ ë°©ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤';
      } else {
        mk.disabled = false;
        mk.removeAttribute('title');
      }
    }
  } catch (error) {
    console.error('ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    roomsBox.innerHTML = '<div class="meta">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
  }
}


    // ë°© ë§Œë“¤ê¸°: ëª¨ë‹¬/í¼ UIë¡œ ëŒ€ì²´
    document.getElementById('mk').addEventListener('click', () => {
      if (document.getElementById('roomModal')) return;
      const modal = document.createElement('div');
      modal.id = 'roomModal';
      modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:#fff;padding:32px 24px;border-radius:12px;min-width:320px;box-shadow:0 4px 24px #0002;max-width:90vw;">
          <h3 style="margin-top:0">ë°© ì„¤ì •</h3>
          <div style="margin-bottom:12px">
            <label>ë°© ì´ë¦„<br><input id="roomTitle" class="input" style="width:100%" value="ìƒˆ ë°©"></label>
          </div>
          <div style="margin-bottom:12px">
            <label>ì„¤ëª…<br><input id="roomDesc" class="input" style="width:100%"></label>
          </div>
          <div style="margin-bottom:12px">
            <label>ìµœëŒ€ ì¸ì›<br><input id="roomMax" class="input" type="number" min="1" max="12" value="4" style="width:80px"></label>
          </div>
          <div style="margin-bottom:12px">
            <label>AI ëª¨ë“œ<br>
              <select id="roomAIMode" class="input">
                <option value="queue">ìˆœì°¨ ë°œí™”(ê¸°ë³¸)</option>
                <option value="free">ììœ  ë°œí™”</option>
              </select>
            </label>
          </div>
          <div style="margin-bottom:12px">
            <label>ê´€ì „ì í—ˆìš©(ëª…)<br><input id="roomSpec" class="input" type="number" min="0" max="20" value="0" style="width:80px"></label>
          </div>
          <div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end;">
            <button id="roomCancel" class="btn">ì·¨ì†Œ</button>
            <button id="roomCreate" class="btn primary">ë°© ë§Œë“¤ê¸°</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('#roomCancel').onclick = () => modal.remove();
      modal.querySelector('#roomCreate').onclick = async () => {
        const title = modal.querySelector('#roomTitle').value.trim() || 'ìƒˆ ë°©';
        const desc = modal.querySelector('#roomDesc').value.trim();
        const maxPlayers = Math.max(1, Math.min(12, parseInt(modal.querySelector('#roomMax').value, 10) || 4));
        const openSlots = Array.from({ length: maxPlayers }, (_, i) => i + 1);
        const aiMode = modal.querySelector('#roomAIMode').value;
        const spectatorsMax = Math.max(0, Math.min(20, parseInt(modal.querySelector('#roomSpec').value, 10) || 0));
        try {
          const { room } = await API.createRoom({
            clientId: Store.state.clientId,
            title,
            desc,
            maxPlayers,
            openSlots,
            aiMode,
            spectatorsMax
          });
          location.href = 'room.html?room=' + room.id;
        } catch (error) {
          alert('ë°© ìƒì„± ì‹¤íŒ¨: ' + error.message);
        }
      };
    });

    // ì±„íŒ… ê¸°ëŠ¥
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    }

    function pushChat(name, text) {
      const div = document.createElement('div');
      div.style.marginBottom = '4px';
      div.innerHTML = `<b>${escapeHtml(name)}:</b> ${escapeHtml(text)}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function sendMessage() {
      const message = txt.value.trim();
      if (!message) return;
      
      txt.value = '';
      WS.chatSend(Store.state.clientId, 'general', Store.state.name, message);
    }

    document.getElementById('send').addEventListener('click', sendMessage);
    txt.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // WebSocket ì—°ê²°
    WS.connect();
    WS.on('LOBBY_STATE', (message) => {
      (message.chat || []).forEach(chat => pushChat(chat.name, chat.text));
    });
    WS.on('CHAT_PUSH', (message) => {
      if (message.message && message.message.roomId === 'lobby') {
        pushChat(message.message.name, message.message.text);
      }
    });

    // ì´ˆê¸°í™”
    WS.join('lobby', Store.state.clientId);
(async () => {
  const active = localStorage.getItem('RSK_ACTIVE_ROOM');
  if (!active) { loadRooms(); return; }

  try {
    const { room } = await API.getRoom(active);
    // ë‚´ê°€ ê·¸ ë°©ì— ì‹¤ì œë¡œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€(ìŠ¬ë¡¯ ì ìœ  or ì†Œì¼“ ì°¸ì—¬ ê¸°ì¤€)ë¥¼ ì²´í¬í•˜ë ¤ë©´
    // room.slots.some(s => s?.clientId === Store.state.clientId) ì •ë„ë¡œ í™•ì¸ ê°€ëŠ¥
    // (room êµ¬ì¡°ì— ë§ì¶° í•„ìš”ì‹œ ë³´ê°•)

  } catch {
    // ë°©ì´ ì—†ê±°ë‚˜ ì ‘ê·¼ ì‹¤íŒ¨ â†’ ìœ ë ¹ ë½
    localStorage.removeItem('RSK_ACTIVE_ROOM');
  } finally {
    loadRooms();
  }
})();
  </script>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í”„ë¡¬í”„íŠ¸ í¸ì§‘ê¸° - Raid Starter Kit</title>
  <link rel="stylesheet" href="../styles/base.css">
<link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="row" style="justify-content: space-between;">
        <b>í”„ë¡¬í”„íŠ¸ í¸ì§‘ê¸°</b>
        <div class="row">
          <a href="lobby.html" class="btn">ë¡œë¹„</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container grid" style="grid-template-columns: 1fr 380px;">
    <section class="card" id="editorBox">
      <div class="row" style="justify-content: space-between;">
        <div><b>í”„ë¡¬í”„íŠ¸ ëª©ë¡</b></div>
        <div>
          <button id="addPrompt" class="btn">ìƒˆ í”„ë¡¬í”„íŠ¸</button>
          <button id="delPrompt" class="btn danger">ì‚­ì œ</button>
        </div>
      </div>
      <select id="promptList" class="input" style="margin-top:8px"></select>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <b>ë‚´ìš©</b>
          <input id="promptLabel" class="input" placeholder="ë¼ë²¨" style="max-width: 240px;">
        </div>
        <textarea id="promptText" class="input mono" rows="10" placeholder="ì—¬ê¸°ì— í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="margin-top:8px"></textarea>
        <div class="row" style="justify-content: flex-end; margin-top:8px">
          <button id="savePrompt" class="btn primary">ì €ì¥</button>
        </div>
      </div>
    </section>

    <aside class="card" id="varsBox">
      <b>ë³€ìˆ˜ íŒ”ë ˆíŠ¸</b>
      <div class="meta" style="margin-top:6px">í•­ëª©ì„ ì„ íƒí•˜ë©´ í…ìŠ¤íŠ¸ì— í•´ë‹¹ ë³€ìˆ˜ê°€ ì‚½ì…ë©ë‹ˆë‹¤.</div>

      <div class="card" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <b>ìºë¦­í„°</b>
          <span class="meta" id="selSlotHint">ì„ íƒ ìŠ¬ë¡¯: 1</span>
        </div>
        <div id="slotsRow" class="row" style="flex-wrap:wrap;gap:6px;margin-top:6px"></div>
        <div id="charFields" class="row" style="flex-wrap:wrap;gap:6px;margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:8px">
        <b>ë°©</b>
        <div id="roomFields" class="row" style="flex-wrap:wrap;gap:6px;margin-top:8px"></div>
      </div>
    </aside>
  </div>

  <script type="module">
    import { Store } from '../core/store.js';

    // ìƒíƒœ
    let list = Store.loadPrompts();
    let curId = list[0]?.id || '';

    // ì—˜ë¦¬ë¨¼íŠ¸
    const sel = document.getElementById('promptList');
    const txt = document.getElementById('promptText');
    const label = document.getElementById('promptLabel');
    const slotsRow = document.getElementById('slotsRow');
    const charFields = document.getElementById('charFields');
    const roomFields = document.getElementById('roomFields');
    const selSlotHint = document.getElementById('selSlotHint');
    let selectedSlot = 1;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ë Œë”ëŸ¬ (ë‹¨ì¼)
    function render() {
      // í•­ìƒ ìµœì‹  ëª©ë¡ ë¡œë“œ
      list = Store.loadPrompts();

      // 1) ëª©ë¡ ì±„ìš°ê¸°
      sel.innerHTML = (list || []).map(p => `<option value="${p.id}">${p.label || p.id}</option>`).join('');

      // 2) í˜„ì¬ ì„ íƒê°’ ë³´ì •
      if (!curId || !list.some(p => p.id === curId)) {
        curId = list[0]?.id || '';
      }
      sel.value = curId || '';

      // 3) ìƒì„¸ ë°˜ì˜
      const cur = list.find(p => p.id === curId);
      txt.value = cur?.text || '';
      label.value = cur?.label || '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ìŠ¬ë¡¯/ë³€ìˆ˜ íŒ”ë ˆíŠ¸ (ì´ˆê¸°í™” 1íšŒ)
    function initSlots() {
      // ìŠ¬ë¡¯ ë²„íŠ¼: 1íšŒ ë Œë”, í´ë¦­ ì‹œ class í† ê¸€ë§Œ
      slotsRow.innerHTML = Array.from({length:12}, (_, i) => {
        const n = i + 1;
        return `<button class="btn${n===selectedSlot ? ' primary' : ''}" data-slot="${n}">${n}</button>`;
      }).join('');

      slotsRow.addEventListener('click', (e) => {
        const n = parseInt(e.target?.dataset?.slot || '', 10);
        if (!n || n === selectedSlot) return;
        selectedSlot = n;
        selSlotHint.textContent = `ì„ íƒ ìŠ¬ë¡¯: ${n}`;
        // í† ê¸€
        slotsRow.querySelectorAll('button').forEach(b => {
          const bn = parseInt(b.dataset.slot, 10);
          b.classList.toggle('primary', bn === selectedSlot);
        });
      });

      // ìºë¦­í„° í•„ë“œ(ì •ì )
      const charFieldDefs = [
        { label:'ì´ë¦„',   build:(n)=>`{{slot${n}.char.name}}` },
        { label:'ì„¤ëª…',   build:(n)=>`{{slot${n}.char.desc}}` },
        { label:'ëŠ¥ë ¥1',  build:(n)=>`{{slot${n}.char.abilities[1].name}} â€” {{slot${n}.char.abilities[1].text}}` },
        { label:'ëŠ¥ë ¥2',  build:(n)=>`{{slot${n}.char.abilities[2].name}} â€” {{slot${n}.char.abilities[2].text}}` },
        { label:'ëŠ¥ë ¥3',  build:(n)=>`{{slot${n}.char.abilities[3].name}} â€” {{slot${n}.char.abilities[3].text}}` },
        { label:'ëŠ¥ë ¥4',  build:(n)=>`{{slot${n}.char.abilities[4].name}} â€” {{slot${n}.char.abilities[4].text}}` },
        { label:'ëª¨ë‘',   build:(n)=>`{{slot${n}.char.all}}` },
      ];
      charFields.innerHTML = charFieldDefs.map((f, i) => `<button class="btn" data-idx="${i}">${f.label}</button>`).join('');
      charFields.addEventListener('click', (e) => {
        const idx = parseInt(e.target?.dataset?.idx || '', 10);
        if (Number.isNaN(idx)) return;
        insertAtCursor(charFieldDefs[idx].build(selectedSlot));
      });

      // ë°© í•„ë“œ(ì •ì )
      const roomFieldDefs = [
        { label:'ì œëª©', tag:'{{room.title}}' },
        { label:'ì„¤ëª…', tag:'{{room.desc}}' },
      ];
      roomFields.innerHTML = roomFieldDefs.map((f, i) => `<button class="btn" data-room="${i}">${f.label}</button>`).join('');
      roomFields.addEventListener('click', (e) => {
        const idx = parseInt(e.target?.dataset?.room || '', 10);
        if (Number.isNaN(idx)) return;
        insertAtCursor(roomFieldDefs[idx].tag);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì¡°ì‘(ì¶”ê°€/ì‚­ì œ/ì €ì¥) â€” Storeì˜ ë‹¨ê±´ API ì‚¬ìš©
    document.getElementById('addPrompt').onclick = () => {
      const id = Store.addPrompt({ label: 'ìƒˆ í”„ë¡¬í”„íŠ¸', text: '' });
      curId = id;
      render();
    };

    document.getElementById('delPrompt').onclick = () => {
      if (!curId) return;
      if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
      Store.removePrompt(curId);
      const next = Store.loadPrompts();
      curId = next[0]?.id || '';
      render();
    };

    document.getElementById('savePrompt').onclick = () => {
      if (!curId) return;
      Store.updatePrompt(curId, {
        label: (label.value || '').trim() || 'í”„ë¡¬í”„íŠ¸',
        text: txt.value || ''
      });
      render();
      alert('ì €ì¥í–ˆìŠµë‹ˆë‹¤');
    };

    // ì„ íƒ ë³€ê²½
    sel.onchange = () => { curId = sel.value; render(); };

    // í…ìŠ¤íŠ¸ ì‚½ì… ìœ í‹¸
    function insertAtCursor(text) {
      const start = txt.selectionStart || 0;
      const end = txt.selectionEnd || start;
      const value = txt.value || '';
      txt.value = value.slice(0, start) + text + value.slice(end);
      txt.focus();
      txt.selectionStart = txt.selectionEnd = start + text.length;
    }

    // ì´ˆê¸°í™”
    initSlots();
    render();
  </script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>

</body>
</html>
